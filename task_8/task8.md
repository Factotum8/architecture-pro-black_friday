# Hot shards 

##Системные метрики (на уровне сервера)  
1. CPU load (общая загрузка и в разрезе на процессы БД).
2. Память: использование RAM, свопинг (повышенное использование swap — тревожный сигнал).
3. Диск: latency чтения/записи, IOPS, заполнение места.
4. Сеть: задержки и пропускная способность для кластеров/реплик.  

## Метрики СУБД (Mongo)
1. Connections: текущее количество соединений, ошибки «too many connections».
2. Locks/Waits: блокировки, deadlocks, долгая конкуренция за ресурсы.
3. Replication lag (так как у нас репликация).
4. Buffer/Cache hit ratio: насколько часто данные читаются из памяти, а не с диска.
5. Temp tables / temp files: частота создания временных структур (признак тяжёлых запросов).
6. Slow queries: количество запросов дольше N ms. N - подбирается эмпирически.

# Rebalance data
В случае больших нагрузок данные внутри 1 гео зоны можно распределять в разные партиции по категориям товаров. Шардирование + встроенный Balancer:  
Коллекция шардируется по ключу; данные разбиваются на chunks (~128 МБ, задаётся chunkSize). 
Balancer в фоне перемещает chunks между шардами, когда видит дисбаланс.

Настройка:
Включить шардирование и зашардировать коллекцию Products:
```
sh.enableSharding("helloDoc");
sh.shardCollection("helloDoc.Products", { geo: 1 });
```
Проверить состояние:
```
sh.status();                     // распределение чанков
sh.getBalancerState();           // включён ли
sh.startBalancer(); 
```
* Параметры: chunkSize, balancing window, migration parallelism limit.
* Авто-сплит/мердж: при росте чанк делится автоматически; 
* При снижении — может сливаться (merge).